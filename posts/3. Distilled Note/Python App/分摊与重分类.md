## 1. 业务需求
---
财务的分摊无非就是把*一行数*变成*多行数*的过程，在这个过程中，数字的总数不变，有可能会*维度增加*，也有可能不增加维度但*某维度的颗粒度会变得更细*。这个分摊的过程，由于业务本质的原因，通常都是用某些指标在某些维度中的*权重*来作为分摊依据的。

## 2. 设计方向
---
#ToDo  +++ 底层逻辑，怎么冲的

在提供分摊逻辑前，我们需要提供的基础信息有：
- 数据库的链接方式，用户名与密码
- 目标表表名，包括库名，模式名以及表名（由于分摊将于原表上进行，因此请提前准备好该表）

接下来，对于分摊逻辑，我们需要做的事情大致如下：
- 设定每次分摊，被分摊数字的范围 => 源筛选
- 设定每次分摊，需要分摊到的维度 => 目标维度
- 设定每次分摊，分摊的方式 => 权重值的计算方式

> [!Info] 
> 因此，我们设定了如下的系统表格，来记录每一条分摊的规则：

- `amort_id`：分摊ID，用来记录分摊的
- `amort_flag`：分摊标识，用来记录数据是否已经被分摊
- `source_filter_{dim}`：源筛选，用来==定位被分摊的数据==
- `amort_to_dim`：目标维度，用来==定位分摊到的维度字段== 
- `{more rules}`：更多规则字段，用来描述分摊的颗粒度，权重等具体规则 
- `start_date`：启用时间，规定生效范围 
- `end_date`：结束时间，规定生效范围 

接下来，我们就会就以上参数进行详细介绍。

### 2.1 分摊ID
`amort_id` 是一个需要在事实表中的额外建立的字段，该字段要在 `insert` 语句生成分摊数据时，对数据进行记录，保证每一条数据都有对应的规则可以回查。

### 2.2 分摊标识
`amort_flag` 分摊标识也是一个需要在事实表中建立的字段，与 `amort_id` 不同的是，该字段并不在 `insert` 语句中，而在 `update` 语句中。

`amort_flag` 的作用是，标记出目标数据是否==已经被分摊==了，如果程序检测到数据已经被分摊过了，那么就没有必要对该数据再进行二次分摊，而是去找没有被分摊过的数据进行处理。

对于某些数据，需要分摊两次，比如说，该数据就是手工总部调整，需要分摊到产品线后再分摊渠道，那么分摊程序需要对第一次分摊前的数据的 `amort_flag` 打标 'Y'，这样第二次分摊时，才会正确的取到第一次分摊后的数据。

### 2.3 源筛选
`source_filter_{dim}` 在分摊参数表中，代表了多个字段，其中的dim占位符，可以替换成任意事实表中的维度进行分摊（需要在事实表中存在）。

该筛选要包含`=`, `<>`, `In`, `Not In`，四种筛选逻辑。 #ToDo 增加`LIKE`匹配逻辑。

> [!tip]
> 分摊:小技巧1：在第二次分摊时，在源筛选 `source_filter_{dim}` 中，增加一个 `amort_id` 维度，这样二次或多次分摊时，只会取到程序正在分摊的数据。
> 
> 分摊小技巧2：也可以在源筛选 `source_filter_{dim}` 中，增加一个 `amort_flag` 维度，该维度永远都是 False，这样就不必再去程序里，专门对该方面写特殊逻辑了
> 
> 分摊小技巧3：在源筛选中，可以增加数据血缘相关的维度，如 `data_source_id`，这样可以对组合起来的数据进行有选择的分摊。假如需求是，仅对序时账做分摊，或仅对序时账调整做分摊，那么这个字段就非常有用了。

### 2.4 目标维度
`amort_to_dim` 是事实表中的一个字段，该维度的生成/重新生成方式需要一张规则表的支持

### 2.5 固定比率规则表

> 情况1：客户需要固定的维度信息与固定的分摊比率

| dim_bu | fixed_ratio |
| ----------- | ----------- |
| BU-A        | 20%         |
| BU-B        | 50%         |
| BU-C        | 30%         |

在上述例子中，我们可以把已有的每一行数据分配为3行，每行数据分配不同的维度，金额乘以不同的权重。那么如果按照上述方式进行分摊，需要客户提供一张固定比率的分摊表，并且标注好比率信息。在该配置中，客户需：
- *必选*，选择目标分摊维度字段
- *必选*，配置分摊权重比率

### 2.6 指标比率

>情况2：客户需要变动的维度信息与变动的指标比率

假设客户需要计算同样ABC BU的收入占比的权重，那么首先我们依然需要一张上述表格，其中 `fixed_ratio` 字段替换成 `rev_ratio` 字段，并且该表应配置后自动生成，不需要客户手动调整。在该配置中，客户需：
- *必选*，选择目标分摊维度字段
- *必选*，配置目标分摊维度值，可手动配置，或选择某维度的全部值
- *必选*，选择存放指标表
- *必选*，选择指标字段
- *可选*，选择指标的维度筛选条件（对指标计算权重的范围，再进行一个框定）

再之后，系统便可以按照目标维度去计算出筛选后的指标的权重。

| dim_product | rev_ratio    |
| ----------- | ------------ |
| BU-A        | （计算结果） |
| BU-B        | （计算结果） |
| BU-C        | （计算结果） |



### 2.7 依赖维度

> 情况3：分摊的目标维度全部汇总并不是100%，也就是说，客户并不是在集团层面进行一次性分摊，而是在某些维度之下，对目标维度进行分摊。

举例说明，假如在每个公司维度下，分摊BU-A，BU-B与BU-C，那么这个公司就是依赖维度，每个公司下的维度权重汇总为100%。那么我们则需要规则表如下：

| dim_company | dim_product | rev_ratio    |
| ----------- | ----------- | ------------ |
| X           | BU-A        | （计算结果） |
| X           | BU-B        | （计算结果） |
| X           | BU-C        | （计算结果） |
| Y           | BU-B        | （计算结果） |
| Y           | BU-C        | （计算结果） |

客户需额外提供：
- *可选*，依赖维度


## 3. 代码实现

#ToDo 写demo code