---
title: RLS案例
author: air.yan
typora-root-url: ..\..\public
date: 2021-08-26 18:47:11
updated:
index_img: /img/index_img/rls.png
category:
  - 案例分析
tags:
---

> RLS（Row-Level Security）是PBI中管控权限最为有效，最为常用的方法。我们不仅可以用他实现最基础的单维度权限分配，还可以实现合并范围权限分配、部分用户数据脱敏、页面级权限管控等非常实用的功能。

<!--more-->

# Row Level Security 行级别安全性

![](/img/index_img/rls.png)

## 一、 权限分配

### 1. 普式RLS应用 & 动态RLS应用

最基础的权限分配方式，已经在官网详细记录，具体请参考以下链接：

https://docs.microsoft.com/en-us/power-bi/admin/service-admin-rls

官网写的很详细啦，最基础的东西不再赘述，请自行查看。如果还是不太清楚的话，网上也有一些基础攻略可以自行google/bing/baidu一下。

### 2. 基于Direct Query to Dataset的RLS应用

混合模型yyds！所以混合模型的RLS应用也非常重要。

但由于Direct Query to Dataset的概念尚未完成编写，此处待更新，敬请期待~

<img src="/img/coming_soon.jpg" style="zoom:50%;" />

## 二、解题方案

### 1. 合并范围权限分配

**难易度：**✴✴✴

财报、管报的抵消合并本身在财务领域已经算得上是进阶知识，要理解这个概念本身就是一件需要花时间的事情了。

在BI中实现合并抵消也并非易事，在建模时，我们要考虑抵消分录与报表项颗粒度的不一致性，还要考虑合并范围层级的建立，以及如何在该层级中加入抵消分录的数据。

在此之后，才是合并范围权限分配的考量。如果是集团报告，又要考虑到角色本身是否要被分配到抵消数据，要抵消的情况中，需要被分配哪一级别的抵消。

总之非常的难，毫无疑问是超高难度解决方案。

**通用性：**✡✡

只有集团级财报，业财融合类报告，才会涉及到合并范围的问题。但，反过来说，只要是集团级报告，就会涉及到该问题。

**解决方案：**

由于合并范围的解题方案尚未编写，此处待更新，敬请期待~

<img src="/img/coming_soon.jpg" style="zoom:50%;" />

### 2.  部分用户数据脱敏

**难易度：**✳

该解题方式运用到新建表及双向关系的思路，虽比较难以想到，但一旦了解思路，问题便迎刃而解，实施时间也非常短。因此难易度为简单。

**通用性：**✳

大多数情况下，我们对数据的管控方式就是显示与不显示，因此用简单的RLS即可。

但一些情况下，出于某种原因，或是模型的限制或是用户的需求，我们需要让一部分终端用户看到脱敏后的数据，如客户张三显示为张xx，银行卡号显示为1112xxxx3434。

但该情况较少见，因此不具备通用性。

**解题方式：**

首先，我们需要建立一张与原始表类似的数据表，这里可以任意选择用PQ或Dax去做。下方的例子是脱敏客户名称的过程。

原始表信息：

| 客户ID | 客户 |
| ------ | ---- |
| 1      | 张三 |
| 2      | 李四 |
| 3      | 王五 |

新建表信息：

| 客户ID | 客户    | RLS标识 |
| ------ | ------- | ------- |
| 1      | 1 - 张* | 1       |
| 2      | 2 - 李* | 1       |
| 3      | 3 - 王* | 1       |
| 1      | 张三    | 2       |
| 2      | 李四    | 2       |
| 3      | 王五    | 2       |

建好了新建表以后，我们用客户ID与原始表进行关联，关系调成双向，然后在模型中将所有的客户字段替换成新建表中的客户，至此，我们就完成了模型+可视化上的调整。

最后一步，在新建表中增加两个RLS角色（比如：脱敏角色，非脱敏角色），分别筛选RLS标识列的1和2，所有步骤就完成了。

最后要记得去线上分享报告时，赋予被分享人以上两个角色其中之一。

### 3. 页面级权限管控

**难易度：**✳

一张角色表 + 一个度量值就能完成的事情，请问能有多难？

**通用性：**✴✴✴

非常非常常见的需求。当你有一套报告，而此报告中的包含了诸多模块，针对不同看报告的角色赋予不同模块的准入权限。那么，留给你的可选项有：

1. 拆报告，在PBI报告层面直接区分出权限最小颗粒度
2. 对当前报告进行权限管控
   * 用RLS的方式进行管控（目前所讲）
   * 用Embedded前端进行Sheet页显示的管控

而目前所讲的是最简单的页面级权限管控方式。

**取舍：**

当你需要用RLS对页面进行管控，那么这个管控一定是字段级别的，因此我们的导航中的可选项一定是按照一个字段来控制的。那么我们的字段可以应用到什么可视化中呢 ---- 切片器。

好的，既然你要用切片器进行页面导航的话，那么首先你就失去了美观的导航设计可能性。你失去了像Youtube，Facebook一样，在左侧摆放诸多漂亮的按钮让用户进行导航的方式。

然后，你又失去了让用户可以一键导航的快捷感受，因为你至少需要让用户：1.选择切片器中的页面 2. 点击导航按钮 ，完成以上两步才能进行导航。

因此，在美观、易用性上，此项可说是略逊一筹。但需求大于一切，完成页面级管控才是重点。

**解决方案：**

早在微软刚刚宣布，“按钮+度量值可以支持页面跳转”时，此方案就已经出现了。不如说，微软就是为了让此方案变得可能而开发的此功能。

具体解决方案非常简单，首先我们需要有一个页面的权限表，根据你运用RLS的方式（固定、动态），我们可以建立以下两种不同的权限表。

固定RLS：

| 页面     | 角色 |
| -------- | ---- |
| 利润分析 | 1    |
| 利润分析 | 2    |
| 费用分析 | 2    |

在固定RLS中，上表有两种角色，角色1可看到一个页面，角色2两个。因此在RLS中我们需要创建1到N个角色。

动态RLS：

| 页面     | 角色                 |
| -------- | -------------------- |
| 利润分析 | zhangsan@company.com |
| 利润分析 | lisi@company.com     |
| 费用分析 | lisi@company.com     |

动态RLS设定中，我们可以设定任意账号可以看到的页面。在RLS中，我们只需要创建一个角色，并且在表达式中写入`'RLS'[角色] = USERNAME()`即可。

然后，我们需要将该“页面”字段，拉到`切片器`中，作为导航用。

再之后，我们需要新建一个`度量值`，直接`SELECTEDVALUE('RLS'[页面])`即可 。这个度量值判断了目前想要导航到的目标页面是什么。

最后，我们再要见一个`按钮`，该按钮被赋予的`操作`为`页面导航`，页面导航的目标是上述度量值。

大功告成！这个简单至极的页面导航方式就此完成，用户进来只需要选择切片器并点击按钮即可导航到相应的页面。

最后小提示，我们的目标是限制用户的导航页面数量，因此最终报告中，用户只能通过上述切片器进行导航，所以一定要把PBI中的Sheet页隐藏掉呀！不隐藏就白做啦！

